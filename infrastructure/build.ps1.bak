# Set the necessary variables
$PROJECT_FOLDER = (Get-Location).Path + "\.."
$INFRA_FOLDER = (Get-Location).Path
$SCA_FOLDER = (Get-Location).Path + "\sca"
$BONITA_ENVIRONMENT = "showroom"
$ENV_FILE="${SCA_FOLDER}\.env-local-ale"
$UIB_FOLDER="${SCA_FOLDER}\ui_builder"

$array = @("bonita", "db", "mail", "UIB")
$prefix = "-f ${SCA_FOLDER}\docker-compose-"
$suffix = ".yml"

# Generate the string array with the prefix and suffix
$modifiedArray = $array | ForEach-Object { "$prefix$_$suffix" }

# Join the array elements with a space
$joinedString = $modifiedArray -join " "

# Remove trailing space
$COMPOSE_FILES = $joinedString.TrimEnd()

Write-Host "compose files: [${COMPOSE_FILES}]"

# Load environment variables from .env file
Get-Content ${ENV_FILE} | ForEach-Object {
    if ($_ -match '^\s*(\w+)\s*=\s*(.*)\s*$') {
        Set-Variable -Name $matches[1] -Value $matches[2]
    }
}

# Cleanup
docker login bonitasoft.jfrog.io
docker-compose -f "${COMPOSE_FILES}" --env-file "${ENV_FILE}" down -v
docker image rm bonita_sca:1.0

# Build
docker image rm "${BONITA_PROJECT_NAME}":"${BONITA_PROJECT_VERSION}"
Set-Location -Path ${PROJECT_FOLDER}
mvn bonita-project:install
mvn clean package -P docker -D bonita.environment=${BONITA_ENVIRONMENT} -D docker.baseImageRepository=bonitasoft.jfrog.io/docker-releases/bonita-subscription -D docker.imageName="${BONITA_PROJECT_NAME}":"${BONITA_PROJECT_VERSION}"

Remove-Item -Recurse -Force "${UIB_FOLDER}\production\ui_builder\workspace"
New-Item -ItemType Directory -Force -Path "${UIB_FOLDER}\production\ui_builder\workspace"
Copy-Item "${PROJECT_FOLDER}\uib\*.json" "${UIB_FOLDER}\production\ui_builder\workspace"

# Build UIB app
Set-Location -Path "${UIB_FOLDER}\production\ui_builder"
docker image rm "${UIB_PROJECT_NAME}":"${UIB_PROJECT_VERSION}"

docker build  -t ${UIB_PROJECT_NAME}:${UIB_PROJECT_VERSION} . --build-arg BASE=${APPSMITH_BASE_IMAGE} --build-arg VERSION=${APPSMITH_VERSION} --build-arg WORKSPACE=./workspace/

# Start
docker-compose -f "${COMPOSE_FILES}" --env-file "${ENV_FILE}" up -d

# Wait for the server to start
& "${INFRA_FOLDER}\healthz.ps1"

# Run tests
Set-Location -Path ${IT_FOLDER}
mvn clean verify -f "${IT_FOLDER}\pom.xml" -D bonita.url=http://localhost:8085/bonita

# Back to Infra Folder
Set-Location -Path ${INFRA_FOLDER}